<script>
  import Icon from "fa-svelte/src/Icon.svelte";
  import { faCog as faSettings } from "@fortawesome/free-solid-svg-icons/faCog";

  import { faCloudDownloadAlt as faDownload } from "@fortawesome/free-solid-svg-icons/faCloudDownloadAlt";
  import { faEye as faSlideshow } from "@fortawesome/free-solid-svg-icons/faEye";
  import { faTimesCircle as faClose } from "@fortawesome/free-solid-svg-icons/faTimesCircle";
  import { faPlusCircle } from "@fortawesome/free-solid-svg-icons/faPlusCircle";
  import { faStar as faFav } from "@fortawesome/free-solid-svg-icons/faStar";

  import Settings from "../components/Settings.svelte";

  import { goto as ahref } from "@sapper/app";

  import { favorite } from "../_prefs";
  favorite.useLocalStorage({});

  let showSettings = false;

  let exploreTumblrUsers = [
    { color: "lightpink", url: "search/art" },
    { color: "lightsalmon", url: "search/photography" },
    { color: "peachpuff", url: "search/illustration" },
    { color: "lavender", url: "search/design" },
    { color: "palegreen", url: "search/fashion" },
    { color: "turquoise", url: "search/food" },
    { color: "wheat", url: "search/travel" },
    { color: "lightskyblue", url: "search/music" },
    { color: "tomato", url: "search/cats" }
  ];

  function toggleSettings() {
    showSettings = !showSettings;
  }

  let displayposts = [];
  let musers = [];

  $: displayposts = $favorite ? Object.entries($favorite) : [];
  $: musers = []; // Multi-user not implemented yet
  $: slideshowurl = ""; // Multi-user not implemented yet

  async function downloadFiles() {
    window.open("/download", "_blank");
  }

  function openSlideshow() {
    ahref(slideshowurl);
  }

  function removeFav(url) {
    $favorite[url] = undefined;
    $favorite = JSON.parse(JSON.stringify($favorite));

    favorite.set($favorite);
  }

  function handleKeydown(e) {
    if (e.key === 'Enter') {
      if (e.target.value.startsWith('/')) {
        const search = e.target.value.slice(1);
        const searchSegments = search.split('/');
        if (searchSegments[0] === 'search' && searchSegments.length > 1) {
          const tag = searchSegments.slice(1).join('/');
          ahref(`/search/${tag}`);
        } else {
          ahref(e.target.value);
        }
      } else {
        ahref(`/user/${e.target.value}`);
      }
    }
  }
</script>

<svelte:head>
  <title>redditpx - home</title>
</svelte:head>

<template lang="pug">
.wrapper
  .hero
    .title
      span.logo
        img(alt="tumblrpx logo", src="logo-192.png")
      | tumblrpx
      .search
        input(type="text", placeholder="Enter Tumblr username or /search/tags", on:keydown="{handleKeydown}")
    .settings
      span.btn(on:click='{toggleSettings}', class:showSettings='{showSettings}')
        Icon(icon="{faSettings}")
      Settings(bind:showSettings='{showSettings}')
    .block.multiuser
      .heading Multi-user {"(" + musers.length + ")"}
        +if('musers.length')
          span.icon.tooltip(on:click="{openSlideshow}", data-tooltip="start slideshow", class:favorite='{musers.length}')
            Icon(icon="{faSlideshow}")
      .items
        +each('musers as [muser, mrdetails]')
          .itemwrapper
            a(href='{`/t/${muser}`}', rel="prefetch")
              .item(style='background-image: url("{mrdetails.preview}")' )
                span {muser}
          +else()
            .itemwrapper.noitems
              .item
                span Add to multi-user using
                span.inlineicon
                  Icon(icon="{faPlusCircle}")
                span or using shortcut
                span.key m
    .block.favs
      .heading Favorites {"(" + displayposts.length + ")"}
        +if('displayposts.length')
          span.icon.tooltip(on:click="{downloadFiles}", data-tooltip="download all", class:favorite='{displayposts.length}')
            Icon(icon="{faDownload}")
      .items
        +each('displayposts as [url, post]')
          .itemwrapper
            span.icon.tooltip(on:click|stopPropagation|preventDefault="{function() {removeFav(url)}}", data-tooltip="remove")
              Icon(icon="{faClose}")
            a(href='{post.url}', target='_blank')
              .item(style='background-image: url("{post.preview.img.default}")' )
                a.subreddit(href='{`/r/${post.subreddit}`}')
                  span {"r/" + post.subreddit}
          +else()
            .itemwrapper.noitems
              .item
                span Add to favorites using
                span.inlineicon
                  Icon(icon="{faFav}")
                span or using shortcut
                span.key x
    .block.explore
      .heading Explore
      .items
        +each('exploreSubreddits as subreddit')
          .itemwrapper.explore
            a(href='{`/${subreddit.url}`}', rel="prefetch")
              .item(style='background-color: {subreddit.color}' )
                span {subreddit.url.replace('search/', '#')}
      .links
        a(href='/t/username')
</template>

<style lang="sass">

@mixin hover()
  @media not all and (pointer:coarse)
    &:hover
      @content

$yellow: #f9ab00

$text-color: #fafafa
$accent-color: white
$favorite-color: #fbbc04
$favorite-border-color: #e37400
$over18-color: #ea4335
$over18-border-color: #ea4335


.wrapper
  height: 100vh

  display: grid
  justify-items: center
  align-items: center

  .hero
    height: 100vh
    width: 100%
    display: grid
    justify-items: center
    align-items: center
    grid-auto-rows: max-content
    grid-row-gap: 3rem
    padding-top: 5rem

    .settings
      z-index: 10
      position: absolute
      top: 0
      right: 0
      color: $text-color
      font-size: 1rem
      padding: 1.5rem

      .btn
        user-select: none
        cursor: pointer
        color: rgba(white, 80%)

        &.showSettings
          color: white

        @include hover()
          color: white

    .title
      z-index: 10
      position: absolute
      top: 0
      color: $text-color
      font-size: 1.5rem
      max-width: 90%
      padding: 1rem
      border-radius: 3px
      cursor: pointer

      .logo
        user-select: none
        cursor: pointer
        top: 5px
        position: relative
        margin-right: 9px

        img
          height: 2rem

      .search
        input
          margin-left: 1rem
          padding: 0.5rem
          border-radius: 5px
          border: 1px solid #ccc
          background-color: #333
          color: white
    .block
      color: $text-color
      padding: 1rem
      width: 100%
      align-self: start

      .heading
        font-size: 1.5rem

        .icon
          top: 3px
          position: relative
          margin-left: 8px

          &.favorite
            color: $favorite-color

      .links
        display: none

      .items
        display: grid
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr))
        grid-gap: 10px
        margin-top: 5px

        .itemwrapper

          &.explore
            .item
              height: 5rem

          &.noitems
            color: darken($text-color, 30%)
            background-color: lighten(black, 10%)
            grid-column: 1 / -1
            border-radius: 3px
            margin-top: 1rem
            display: grid
            justify-content: center

            .item
              padding: 4rem

              .inlineicon
                margin: 0 4px
                top: 2px
                position: relative
                color: white

              .key
                color: darken($text-color, 30%)
                margin: 0 4px
                border: 1px solid darken($text-color, 30%)
                border-radius: 3px
                top: -1px
                position: relative
                line-height: 1.3rem
                padding: 0 5px


          @include hover()
            .icon
              opacity: 1

          @include hover()
            span
              opacity: 1 !important


          .icon
            position: relative
            float: right
            margin: 1.1rem
            opacity: 0
            color: $favorite-color
            font-size: 1.3rem

          a
            color: $text-color
            text-decoration: none

            .item
              padding: 1rem
              height: 10rem
              background-size: cover
              background-position: center
              border-radius: 3px

              & .subreddit
                span
                  opacity: 0

              span
                background-color: black
                padding: 0.3rem
                border-radius: 3px


.tooltip
  position: relative
  z-index: 2
  cursor: pointer

.tooltip
  &:before, &:after
    visibility: hidden
    opacity: 0
    pointer-events: none

  &:before
    position: absolute
    bottom: 120%
    left: 50%
    margin-bottom: 5px
    margin-left: -30px
    padding: 5px 4px
    width: 60px
    border-radius: 3px
    background-color: black
    color: #fff

    background-color: rgba(white, 90%)
    color: black

    content: attr(data-tooltip)
    text-align: center
    font-size: 0.8rem
    line-height: 1.2

  &:after
    position: absolute
    bottom: 120%
    left: 50%
    margin-left: -5px
    width: 0
    border-top: 5px solid #000
    border-top: 5px solid hsla(0, 0%, 20%, 0.9)
    border-right: 5px solid transparent
    border-left: 5px solid transparent
    content: " "
    font-size: 0
    line-height: 0

  &:hover
    &:before, &:after
      visibility: visible
      opacity: 1

</style>